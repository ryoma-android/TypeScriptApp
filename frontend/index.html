<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>令和トラベル - 旅行アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .auth-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .travels-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .travel-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .travel-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .travel-info {
            color: #666;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .status-planning { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .hidden {
            display: none;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✈️ 令和トラベル</h1>
            <p>あなたの旅行を管理しましょう</p>
        </div>
        
        <!-- ログイン/登録セクション -->
        <div id="authSection" class="auth-section">
            <h2>ログイン / 新規登録</h2>
            <div id="authError" class="error hidden"></div>
            <div id="authSuccess" class="success hidden"></div>
            
            <div class="form-group">
                <label for="name">お名前（新規登録時のみ）:</label>
                <input type="text" id="name" placeholder="お名前を入力">
            </div>
            
            <div class="form-group">
                <label for="email">メールアドレス:</label>
                <input type="email" id="email" placeholder="メールアドレスを入力">
            </div>
            
            <div class="form-group">
                <label for="password">パスワード:</label>
                <input type="password" id="password" placeholder="パスワードを入力">
            </div>
            
            <button class="btn" onclick="login()">ログイン</button>
            <button class="btn btn-secondary" onclick="register()">新規登録</button>
        </div>
        
        <!-- 旅行管理セクション -->
        <div id="travelsSection" class="travels-section hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>あなたの旅行</h2>
                <div>
                    <button class="btn" onclick="showAddTravelForm()">新しい旅行を追加</button>
                    <button class="btn btn-secondary" onclick="logout()">ログアウト</button>
                </div>
            </div>
            
            <div id="travelsList"></div>
            
            <!-- 旅行追加フォーム -->
            <div id="addTravelForm" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3>新しい旅行を追加</h3>
                <div class="form-group">
                    <label for="travelTitle">旅行のタイトル:</label>
                    <input type="text" id="travelTitle" placeholder="例: 京都旅行">
                </div>
                <div class="form-group">
                    <label for="travelDestination">目的地:</label>
                    <input type="text" id="travelDestination" placeholder="例: 京都">
                </div>
                <div class="form-group">
                    <label for="travelStartDate">開始日:</label>
                    <input type="date" id="travelStartDate">
                </div>
                <div class="form-group">
                    <label for="travelEndDate">終了日:</label>
                    <input type="date" id="travelEndDate">
                </div>
                <div class="form-group">
                    <label for="travelBudget">予算（円）:</label>
                    <input type="number" id="travelBudget" placeholder="100000">
                </div>
                <div class="form-group">
                    <label for="travelParticipants">参加者数:</label>
                    <input type="number" id="travelParticipants" placeholder="2" min="1">
                </div>
                <div class="form-group">
                    <label for="travelDescription">説明:</label>
                    <input type="text" id="travelDescription" placeholder="旅行の説明（任意）">
                </div>
                <button class="btn" onclick="addTravel()">旅行を追加</button>
                <button class="btn btn-secondary" onclick="hideAddTravelForm()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000/api';
        let currentUser = null;
        let authToken = null;

        // 認証関連の関数
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('メールアドレスとパスワードを入力してください');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', authToken);
                    showSuccess('ログインに成功しました');
                    showTravelsSection();
                    loadTravels();
                } else {
                    showError(data.message || 'ログインに失敗しました');
                }
            } catch (error) {
                showError('サーバーに接続できません');
            }
        }

        async function register() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!name || !email || !password) {
                showError('すべてのフィールドを入力してください');
                return;
            }
            
            if (password.length < 6) {
                showError('パスワードは6文字以上である必要があります');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', authToken);
                    showSuccess('登録に成功しました');
                    showTravelsSection();
                    loadTravels();
                } else {
                    showError(data.message || '登録に失敗しました');
                }
            } catch (error) {
                showError('サーバーに接続できません');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('token');
            showAuthSection();
        }

        // UI表示制御
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('travelsSection').classList.add('hidden');
        }

        function showTravelsSection() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('travelsSection').classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        // 旅行管理の関数
        async function loadTravels() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/travels`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const travels = await response.json();
                displayTravels(travels);
            } catch (error) {
                console.error('旅行データの読み込みに失敗:', error);
            }
        }

        function displayTravels(travels) {
            const travelsList = document.getElementById('travelsList');
            
            if (travels.length === 0) {
                travelsList.innerHTML = '<p>まだ旅行がありません。新しい旅行を追加してみましょう！</p>';
                return;
            }
            
            travelsList.innerHTML = travels.map(travel => `
                <div class="travel-card">
                    <h3>${travel.title}</h3>
                    <div class="status status-${travel.status}">${getStatusLabel(travel.status)}</div>
                    <div class="travel-info">
                        <strong>目的地:</strong> ${travel.destination}<br>
                        <strong>期間:</strong> ${formatDate(travel.startDate)} - ${formatDate(travel.endDate)}<br>
                        <strong>予算:</strong> ¥${travel.budget.toLocaleString()}<br>
                        <strong>参加者:</strong> ${travel.participants}人
                    </div>
                    <button class="btn" onclick="editTravel('${travel._id}')">編集</button>
                    <button class="btn btn-secondary" onclick="deleteTravel('${travel._id}')">削除</button>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'planning': '計画中',
                'confirmed': '確定',
                'completed': '完了',
                'cancelled': 'キャンセル'
            };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ja-JP');
        }

        function showAddTravelForm() {
            document.getElementById('addTravelForm').classList.remove('hidden');
        }

        function hideAddTravelForm() {
            document.getElementById('addTravelForm').classList.add('hidden');
            // フォームをリセット
            document.getElementById('travelTitle').value = '';
            document.getElementById('travelDestination').value = '';
            document.getElementById('travelStartDate').value = '';
            document.getElementById('travelEndDate').value = '';
            document.getElementById('travelBudget').value = '';
            document.getElementById('travelParticipants').value = '';
            document.getElementById('travelDescription').value = '';
        }

        async function addTravel() {
            const title = document.getElementById('travelTitle').value;
            const destination = document.getElementById('travelDestination').value;
            const startDate = document.getElementById('travelStartDate').value;
            const endDate = document.getElementById('travelEndDate').value;
            const budget = document.getElementById('travelBudget').value;
            const participants = document.getElementById('travelParticipants').value;
            const description = document.getElementById('travelDescription').value;
            
            if (!title || !destination || !startDate || !endDate || !budget || !participants) {
                alert('必須フィールドを入力してください');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/travels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        title,
                        destination,
                        startDate,
                        endDate,
                        budget: parseInt(budget),
                        participants: parseInt(participants),
                        description
                    })
                });
                
                if (response.ok) {
                    hideAddTravelForm();
                    loadTravels();
                    showSuccess('旅行が追加されました');
                } else {
                    const data = await response.json();
                    alert(data.message || '旅行の追加に失敗しました');
                }
            } catch (error) {
                alert('サーバーに接続できません');
            }
        }

        async function deleteTravel(travelId) {
            if (!confirm('この旅行を削除しますか？')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/travels/${travelId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    loadTravels();
                    showSuccess('旅行が削除されました');
                } else {
                    alert('削除に失敗しました');
                }
            } catch (error) {
                alert('サーバーに接続できません');
            }
        }

        function editTravel(travelId) {
            alert('編集機能は今後実装予定です');
        }

        // ページ読み込み時の処理
        window.onload = function() {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                authToken = savedToken;
                // トークンが有効かチェック
                checkAuth();
            }
        };

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showTravelsSection();
                    loadTravels();
                } else {
                    localStorage.removeItem('token');
                    authToken = null;
                }
            } catch (error) {
                localStorage.removeItem('token');
                authToken = null;
            }
        }
    </script>
</body>
</html>
